---
title: "AWSのプライベートサブネットに配置されたEC2へのSession Managerを使ったアクセス"
emoji: "🙆"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [AWS]
published: true
---



AWS EC2インスタンスをプライベートサブネットに配置し、AWS Systems ManagerのSession Managerを使用して接続する方法について説明します。以下の手順に従ってください。
※VPCの作成、プライベートサブネットは作成はここでは扱いません。

## 目次

1. Session Managerについて
2. プライベートサブネットにEC2インスタンスを作成する
3. ステップ1: EC2インスタンスの作成
4. ステップ2: IAMロールの作成
5. ステップ3: EC2インスタンスにIAMロールをアタッチ
6. ステップ4: VPCエンドポイントの作成
7. ステップ5: Session ManagerでEC2にアクセスする
8. まとめ
9. 参考資料


## Session Managerについて

Session ManagerはAWS Systems Managerの一部であり、安全にマネージドインスタンス（EC2インスタンスやOn-Premises Server）に接続するためのツールです。Session Managerを使用すれば、SSHキーの管理やインスタンスにパブリックIPを割り当てることなく、AWSのプライベートサブネットに配置されたEC2インスタンスに接続することができます。

## プライベートサブネットにEC2インスタンスを作成する

### ステップ1: EC2インスタンスの作成

1. AWS管理コンソールから「EC2」ダッシュボードに移動します。
![](/images/3559db9605d198/330D49EC-552D-40EA-A333-608BEA80553D.jpeg)
2. 「インスタンスの起動」ボタンをクリックします。
![](/images/3559db9605d198/89EA6764-45FA-4624-A9FC-7892BBF56BD7.jpeg)
3. EC2の名前を入力します。ここでは「test-ec2」
![](/images/3559db9605d198/A42A0BB2-3E49-47A6-AB45-827C80E4022B.jpeg)
4. AMIとインスタンスタイプを選択します。
今回はセッションマネージャーを使用するので、キーペアはなしで続行を選択します。
![](/images/3559db9605d198/49EE3761-CB95-4334-930D-C3C4E5E18D66.jpeg)
5. ここで、ネットワークとサブネットの設定で、VPCとプライベートサブネットを選択します。
セキュリティーグループを作成するを選択して、セキュリティグループのルールは「削除」します。
これから作成するEC2には開放されているポートはない状態で作成されます。
![](/images/3559db9605d198/AB3849C1-B717-4BD6-AC5F-C6E4403160DD.jpeg)
6. 「インスタンスを起動」をクリックします。

![](/images/3559db9605d198/6D876538-7A56-4E9C-A915-8E4616D43CB3.jpeg)
EC2インスタンスの作成は完了です。
### ステップ2: IAMロールの作成

AmazonSSMManagedInstanceCoreというマネージドポリシーを持つIAMロールを作成する手順をご説明します。

1. AWS管理コンソールにログインし、「IAM」サービスを開きます。
![](/images/3559db9605d198/B8983FBC-83EF-4C47-94A4-BF885FA7B712.jpeg)
2. 左側のパネルで「ロール」をクリックします。
![](/images/3559db9605d198/C2BAB3BE-C0D2-44DE-B7B3-01BFF299A154.jpeg)
3. 「ロールの作成」ボタンをクリックします。
![](/images/3559db9605d198/42DCE970-EC6A-408C-A0B1-59EF3B461062_4_5005_c.jpeg)
4. 「AWSサービス」を選択し、「EC2」を選択します。これにより、EC2インスタンスがこのロールを使用できるようになります。「次のステップ：アクセス権限」をクリックします。
![](/images/3559db9605d198/808F33F1-1F32-4048-9720-EFA0D351D0CF.jpeg)
5. ポリシーの検索ボックスに「AmazonSSMManagedInstanceCore」と入力し、該当するポリシーをチェックします。「次へ」をクリックします。
![](/images/3559db9605d198/121AF2EB-B274-4842-B36D-D927E7D65301.jpeg)
6.  ロールの名前と、必要であれば説明を入力します。その後、「ロールの作成」をクリックします。
![](/images/3559db9605d198/2A0ADE57-ACBB-45A5-B3F9-88569CE0988E.jpeg)
![](/images/3559db9605d198/25B41F9C-F547-4486-B177-0E1A85E1FBCC.jpeg)
![](/images/3559db9605d198/C34CC056-C154-43A4-8E65-F922AE9ACCA4_4_5005_c.jpeg)
IAMロールの作成を完了です。

### ステップ3: EC2インスタンスにIAMロールをアタッチ

1. AWS管理コンソールから「EC2」サービスを開きます。
![](/images/3559db9605d198/330D49EC-552D-40EA-A333-608BEA80553D.jpeg)
2. 左側のパネルで「インスタンス」をクリックし、対象のインスタンスを選択します。
![](/images/3559db9605d198/CD0C43E6-A031-4E4D-9D09-B485D27445E2_4_5005_c.jpeg)
3. 「アクション」→「セキュリティ」→「IAMロールの変更」を選択します。
![](/images/3559db9605d198/9E3C1CD2-2B79-4CB6-91B2-5D03ABA33843.jpeg)
4. 「IAMロール」ドロップダウンメニューから先程作成したIAMロールを選択し、「IAMロールの更新」をクリックします。
![](/images/3559db9605d198/BB03C669-0F6C-45C0-B52F-862B4DF0F635.jpeg)

これでEC2インスタンスはAmazonSSMManagedInstanceCoreポリシーを持つIAMロールを使ってAWS Systems ManagerのSession Managerと通信することができます。

※パブリックサブネットに配置されているEC2はIAMロールのアタッチのみでセッションマネージャー経由でアクセスできます。
### ステップ4: VPCエンドポイントの作成

AWS Management Consoleを使ってVPCエンドポイントを作成する手順を以下に示します。今回は、東京リージョン（ap-northeast-1）を例にしますが、他のリージョンを使用している場合は、それに応じて変更してください。

1. サービスメニューから「VPC」を選択します。
![](/images/3559db9605d198/20F7BFAB-488A-4BF1-BCD9-94898B3306F2.jpeg)
2. VPCダッシュボードの左側のパネルで「セキュリティーグループ」を選択します。
![](/images/3559db9605d198/08B6BE74-6667-4B1F-8CC5-0AF48088311A.jpeg)
3. セキュリティーグループ名を入力し、インバウンドルールで『HTTPS」のポートをついかします。
セキュリティグループを作成をクリックします。
![](/images/3559db9605d198/61782BEE-58E6-46A4-B60C-BE147F9C67B6.jpeg)

4. VPCダッシュボードの左側のパネルで「エンドポイント」を選択します。
![](/images/3559db9605d198/B5FB96B7-B8ED-46CD-97B7-7D34F622D683.jpeg)

5. 「エンドポイントの作成」ボタンをクリックします。
![](/images/3559db9605d198/3F7672A8-E041-4DE4-B578-2B4B239509E9.jpeg)

6. エンドポイント名を入力、サービス検索欄に「ssm」を入力してEnterを押すと候補がでます。
.ssm で終わるエンドポイントを選択します。：
    - `com.amazonaws.ap-northeast-1.ssm`

![](/images/3559db9605d198/FE2D89FD-84A5-4DF0-88AD-ED86E34489BC.jpeg)
7. 「VPC」ドロップダウンメニューから、適切なVPCを選択します。

8. 「サブネット」セクションで、エンドポイントを配置したいすべてのサブネットを選択します。
今回はEC2を配置した、プライベートサブネットを選択します。
選択したAZ分料金が発生するので、使用しないものにはチェックをつけないようにしてください。
9. 先ほど作成した、VPCエンドポイント用のセキュリティグループを選択します。
![](/images/3559db9605d198/0A02D4AB-A242-4A3D-A6A9-7AFCB44A07F8.jpeg)

10. 「エンドポイントの作成」ボタンをクリックします。
![](/images/3559db9605d198/FEA8FD7B-8CF9-4118-A5E8-39739228DD34.jpeg)

これらの手順を次のすべてのサービス名（ec2messages、ssmmessages）に対して繰り返します。これにより、プライベートサブネットに配置されたEC2インスタンスがこれらのサービスと直接通信できるようになります。これは、Session ManagerがEC2インスタンスと通信するために必要な設定です。
    ■ `com.amazonaws.ap-northeast-1.ec2messages` の作成画面
![](/images/3559db9605d198/76CEAF91-D0EB-4532-B382-8A264E9ED26F.jpeg)
    ■ `com.amazonaws.ap-northeast-1.ssmmessages`の作成画面
![](/images/3559db9605d198/B6761FF3-85EC-4868-B9AD-B3A9B3FFD010.jpeg)

最終のVPCエンドポイントの一覧
![](/images/3559db9605d198/100A7F0D-E20F-48B0-9D2E-412C236828FC_4_5005_c.jpeg)
### ステップ5: Session ManagerでEC２にアクセスする。

1. AWS管理コンソールから「EC2」サービスを開きます。
![](/images/3559db9605d198/330D49EC-552D-40EA-A333-608BEA80553D.jpeg)
2. 左側のパネルで「インスタンス」をクリックし、対象のインスタンスを選択して、上の「接続」ボタンをクリックします。
![](/images/3559db9605d198/54C29871-D2F8-4EDB-BAD3-2083CF2D5341_4_5005_c.jpeg)
3. セッションマネージャーを選択して「接続」ボタンをクリックします。
![](/images/3559db9605d198/418B968F-7FCB-4668-8CB9-59E2CB64596D.jpeg)

4. プライベートサブネットに配置されたEC2へのSession Managerを使ったアクセスができました。
![](/images/3559db9605d198/2C1C3AA3-1C7B-478C-9265-44881EE30DEC_4_5005_c.jpeg)




## まとめ

この記事では、プライベートサブネット内のEC2インスタンスに接続するためのSession Managerの使用方法を紹介しました。この機能により、SSHキーの管理やパブリックIPの割り当てなしで、プライベートサブネットに配置されたEC2インスタンスに安全にアクセスすることができます。

ハンズオン形式のガイドを読んでいただきありがとうございました。AWSの管理と運用が少しでも楽になれば幸い


## 注意点

VPCエンドポイント作成して、セッションマネージャーでEC2に接続しようとするとエラーになることがあります。
その場合は、時間をあける、インスタンス一覧画面を更新を試してみてください。
それでも接続できない場合は、設定が足りていない場合があるので、確認する必要があります。



## 参考資料

セッションマネージャー越しにSSHアクセスすると何が嬉しいのか
https://dev.classmethod.jp/articles/ssh-through-session-manager/

セッションマネージャーのハマりどころをパターンごとに整理してみる
https://dev.classmethod.jp/articles/session-manager-pattern/
